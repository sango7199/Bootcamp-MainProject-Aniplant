<!-- �럹�씠吏��쓽 �젣紐� �꽕�젙 -->
    <title>怨꾩젙 �젙蹂� �닔�젙</title>

<!-- �빐�떦 �럹�씠吏� 怨좎쑀 CSS 異붽� -->
<th:block layout:fragment="css">
	<style>
        .error {
            color: red;
            font-size: 12px;
        }
	</style>
</th:block>
 
	<div class="content">
		<h2>怨꾩젙 �젙蹂� �닔�젙</h2>
		<form id="update_form" name="update_form" method="post" action="">
            <input type="text" id="idUpdateInput" name="id" th:value="${user.id}" disabled><br> 
            <input type="password" id="passwordUpdateInput" name="password" placeholder="蹂�寃� �떆 鍮꾨�踰덊샇瑜� �엯�젰�빐二쇱꽭�슂"><span id="passwordError" class="error"></span><br>
            <input type="password" id="passwordUpdateConfirmInput" name="password_confirm" placeholder="鍮꾨�踰덊샇 �솗�씤"><span id="passwordConfirmError" class="error"></span><span id="passwordCheckError" class="error"></span><br>
            <input type="email" id="emailUpdateInput" name="email" placeholder="鍮꾨�踰덊샇 遺꾩떎 �떆 �솗�씤�슜 �씠硫붿씪" th:value="${user.email}"><span id="emailError" class="error"></span><br>
            <input type="text" id="nicknameUpdateInput" name="nickname" placeholder="�땳�꽕�엫" maxlength="10" th:value="${user.nickname}"><button type="button" id="checkNickname" class="check_btn">以묐났 �솗�씤</button><span id="nicknameError" class="error"></span><br>
            <input type="text" id="nameUpdateInput" name="name" th:value="${user.name}" disabled><br> 
            <input type="text" id="birthUpdateInput" name="birth" th:value="${#dates.format(user.birth, 'yyyy-MM-dd')}" disabled><br> 
            <input type="tel" id="telUpdateInput" name="tel" placeholder="'-'瑜� �룷�븿�븳 �쑕���쟾�솕踰덊샇" th:value="${user.country_code + '-' + user.first_hp + '-' + user.second_hp}"><span id="telError" class="error"></span><br>
            <ul class="gender_list">
                <li><input type="radio" id="genderIdentity1" name="gender" value="M" th:checked="${user.gender == 'M'}" disabled><label for="genderIdentity1">�궓�옄</label></li>
                <li><input type="radio" id="genderIdentity2" name="gender" value="F" th:checked="${user.gender == 'F'}" disabled><label for="genderIdentity2">�뿬�옄</label></li>
            </ul>
            <button type="button" id="update_btn" class="btn_submit">怨꾩젙 �젙蹂� �닔�젙�븯湲�</button>
		</form>
	</div>
	
<script th:inline="javascript">
	var userData = /*[[${user}]]*/ {};
</script>
<script>
    $(document).ready(function() {
		
    	// �궗�슜�븷 蹂��닔 �꽑�뼵

        var originalNickname = $("#nicknameUpdateInput").val();
        var isNicknameChanged = false;
        var isNicknameChecked = false;
        var passwordPattern = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{10,}$/;
        var emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        var telPattern = /^[0-9]{3}-[0-9]{4}-[0-9]{4}$/;
        var originalTel = $("#telUpdateInput").attr("th:value");
        var userNum = [['${user.user_num}']];
        var userId = userData.id;

        
        // �땳�꽕�엫 蹂�寃� �솗�씤
        $("#nicknameUpdateInput").change(function() {
            var currentNickname = $(this).val();
            if (currentNickname !== originalNickname) {
                isNicknameChanged = true;
            }
            isNicknameChecked = false;
            $("#nicknameError").text("");
        });

        // �땳�꽕�엫 以묐났 泥댄겕 
        $("#checkNickname").click(function() {
            var currentNickname = $("#nicknameUpdateInput").val();
            if (!currentNickname) {
                $("#nicknameError").text("�땳�꽕�엫�쓣 �엯�젰�빐二쇱꽭�슂.");
                return;
            }

            $.ajax({
                url: "/api/check-nickname",
                type: "POST",
                data: { nickname: currentNickname },
                success: function(response) {
                    if (response.isDuplicate) {
                        $("#nicknameError").text("�씠誘� �궗�슜以묒씤 �땳�꽕�엫�엯�땲�떎.");
                    } else {
                        $("#nicknameError").text("�궗�슜 媛��뒫�븳 �땳�꽕�엫�엯�땲�떎.");
                        isNicknameChecked = true;
                    }
                }
            });
        }); 

        // �닔�젙 踰꾪듉 �겢由��떆 濡쒖쭅
        $("#update_btn").click(function() {
            var isValid = true;

            // 鍮꾨�踰덊샇 �쑀�슚�꽦 寃��궗
            var pwd = $("#passwordUpdateInput").val();
            var pwd_confirm = $("#passwordUpdateConfirmInput").val();
            if (pwd) {
                if (!passwordPattern.test(pwd)) {
                    $("#passwordError").text("鍮꾨�踰덊샇�뒗 理쒖냼 10�옄由� �씠硫�, �쁺臾� ���냼臾몄옄, �닽�옄, �듅�닔臾몄옄瑜� �룷�븿�빐�빞 �빀�땲�떎.");
                    isValid = false;
                } else {
                    $("#passwordError").text("");
                }
                if (!pwd_confirm) {
                    $("#passwordConfirmError").text("鍮꾨�踰덊샇 �솗�씤�쓣 �엯�젰�빐二쇱꽭�슂.");
                    isValid = false;
                } else if (pwd !== pwd_confirm) {
                    $("#passwordCheckError").text("鍮꾨�踰덊샇媛� �씪移섑븯吏� �븡�뒿�땲�떎.");
                    isValid = false;
                } else {
                    $("#passwordConfirmError").text("");
                    $("#passwordCheckError").text("");
                }
            }
 
            // �씠硫붿씪 �쑀�슚�꽦 寃��궗
            var email = $("#emailUpdateInput").val();
            if (email && !emailPattern.test(email)) {
                $("#emailError").text("�쑀�슚�븳 �씠硫붿씪 �삎�떇�씠 �븘�떃�땲�떎.");
                isValid = false;
            } else {
                $("#emailError").text("");
            }

            // �땳�꽕�엫 蹂�寃� 諛� 以묐났 �솗�씤
            if (isNicknameChanged && !isNicknameChecked) {
                $("#nicknameError").text("�땳�꽕�엫�씠 蹂�寃쎈릺�뿀�뒿�땲�떎. 以묐났 �솗�씤�쓣 �빐二쇱꽭�슂.");
                isValid = false;
            }

            // �쟾�솕踰덊샇 �쑀�슚�꽦 寃��궗
            var telInput = $("#telUpdateInput").val();
            if (telInput !== originalTel) {
                if (!telInput) {
                    $("#telError").text("�쟾�솕踰덊샇瑜� �엯�젰�빐二쇱꽭�슂.");
                    isValid = false;
                } else if (!telPattern.test(telInput)) {
                    $("#telError").text("�쑀�슚�븳 �쟾�솕踰덊샇 �삎�떇�씠 �븘�떃�땲�떎.");
                    isValid = false;
                } else {
                    $("#telError").text("");
                }
            }

            if (!isValid) {
                return;  // �쑀�슚�꽦 寃��궗 �떎�뙣�떆 �븿�닔 醫낅즺
            }
            
        	// �쟾�솕踰덊샇 �꽭 �옄由щ줈 援щ텇�븯�뒗 濡쒖쭅
            var telInput = $("#telUpdateInput").val();
            var telParts = telInput.split("-");
            
            // �쁽�옱 �궇吏쒖� �떆媛꾩쓣 timestamp濡� �엯�젰�븯�뒗 濡쒖쭅
            var date = new Date();
            date.setHours(date.getHours() + 9); // �븳援��� UTC濡쒕��꽣 +9�떆媛꾩씠誘�濡� 9瑜� �뜑�븿
            var timestamp = date.toISOString();
            var updated_at = timestamp

            var formData = { // �쟾�넚�븷 formData
            	user_num: userNum,
            	id: userId,
                email: $("#emailUpdateInput").val(),
                nickname: $("#nicknameUpdateInput").val(),
                birth: $("#birthUpdateInput").val() + "T00:00:00",
                country_code: telParts[0],
                first_hp: telParts[1],
                second_hp: telParts[2],
                updated_user_num: userNum,
                updated_at: updated_at
            };

            // 鍮꾨�踰덊샇媛� 蹂�寃쎈릺�뿀�쓣 寃쎌슦�뿉留� formData�뿉 ���옣
            if (pwd) {
                formData.pwd = pwd;
            }
			
         	// AJAX �쉶�썝�젙蹂� �닔�젙 post �슂泥� 濡쒖쭅
            $(this).prop("disabled", true);  // �젙蹂� �닔�젙 踰꾪듉 鍮꾪솢�꽦�솕
            $.ajax({
                url: "/api/update-user",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(formData),
                success: function(response) {
                    alert("�쉶�썝�젙蹂닿� �닔�젙�릺�뿀�뒿�땲�떎.");
                    // console.log(formData);
                    window.location.href = "/mypage/my-info-management.do";
                },
                error: function(xhr, status, error) {
                    alert("�쉶�썝 �젙蹂� �닔�젙 以� �삤瑜섍� 諛쒖깮�뻽�뒿�땲�떎.");
                },
                complete: function() {
                  $("#update_btn").prop("disabled", false);  // �젙蹂� �닔�젙 踰꾪듉 �솢�꽦�솕
                }
            });

             
        });
    });
</script>
